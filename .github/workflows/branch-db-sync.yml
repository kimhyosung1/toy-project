name: ğŸ”„ Branch-specific Database Sync

on:
  workflow_run:
    workflows: ['ğŸš€ Main Services CI/CD']
    types:
      - completed
    branches: [dev, qa, production]

env:
  NODE_VERSION: '22'

jobs:
  database-sync:
    name: ğŸš€ Database Sync & Auto Commit
    runs-on: ubuntu-latest
    if: |
      contains(fromJson('["dev", "qa", "production"]'), github.ref_name) && 
      github.event.workflow_run.conclusion == 'success'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Global Dependencies
        run: |
          npm install -g ts-node typescript

      - name: ğŸ”§ Setup Database Environment
        run: |
          case "${{ github.ref_name }}" in
            "dev")
              # DEV í™˜ê²½ í•˜ë“œì½”ë”© (env/dev.env ì°¸ì¡°)
              echo "DB_HOST=localhost" >> $GITHUB_ENV
              echo "DB_PORT=3306" >> $GITHUB_ENV
              echo "DB_USERNAME=root" >> $GITHUB_ENV
              echo "DB_PASSWORD=" >> $GITHUB_ENV
              echo "DB_DATABASE=public" >> $GITHUB_ENV
              ;;
            "qa")
              echo "DB_HOST=${{ secrets.QA_DB_HOST }}" >> $GITHUB_ENV
              echo "DB_PORT=${{ secrets.QA_DB_PORT }}" >> $GITHUB_ENV
              echo "DB_USERNAME=${{ secrets.QA_DB_USER }}" >> $GITHUB_ENV
              echo "DB_PASSWORD=${{ secrets.QA_DB_PASSWORD }}" >> $GITHUB_ENV
              echo "DB_DATABASE=${{ secrets.QA_DB_NAME }}" >> $GITHUB_ENV
              ;;
            "production")
              echo "DB_HOST=${{ secrets.PROD_DB_HOST }}" >> $GITHUB_ENV
              echo "DB_PORT=${{ secrets.PROD_DB_PORT }}" >> $GITHUB_ENV
              echo "DB_USERNAME=${{ secrets.PROD_DB_USER }}" >> $GITHUB_ENV
              echo "DB_PASSWORD=${{ secrets.PROD_DB_PASSWORD }}" >> $GITHUB_ENV
              echo "DB_DATABASE=${{ secrets.PROD_DB_NAME }}" >> $GITHUB_ENV
              ;;
          esac

      - name: ğŸš€ Run Database Sync & Auto Commit
        run: |
          # í™˜ê²½ ë§¤í•‘
          ENV_NAME="${{ github.ref_name }}"
          if [ "$ENV_NAME" = "production" ]; then
            ENV_NAME="prod"
          fi

          echo "ğŸš€ Running database sync for $ENV_NAME environment..."

          # ë³€ê²½ì‚¬í•­ ì¶”ì 
          git status --porcelain > /tmp/before.txt

          # DB ë™ê¸°í™” ì‹¤í–‰
          chmod +x scripts/run-enhanced-db-sync.sh
          ./scripts/run-enhanced-db-sync.sh "$ENV_NAME"

          # ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
          git status --porcelain > /tmp/after.txt

          if ! diff -q /tmp/before.txt /tmp/after.txt > /dev/null; then
            echo "ğŸ“ Changes detected, committing..."
            
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action Bot"
            
            git add -A
            git commit -m "ğŸ¤– Auto-sync database schema from $ENV_NAME environment [skip ci]"
            git push origin ${{ github.ref_name }}
            
            echo "âœ… Changes committed and pushed!"
          else
            echo "ğŸ“ No changes detected"
          fi
