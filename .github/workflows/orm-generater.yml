name: ğŸ”„ Branch-specific Database Sync

on:
  push:
    branches: [qa, production]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to sync (dev/qa/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - prod

env:
  NODE_VERSION: '22'

jobs:
  database-sync:
    name: ğŸš€ Database Sync & Auto Commit
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: â³ Wait for Main Services CI/CD to complete
        if: github.event_name == 'push'
        run: |
          echo "â³ Waiting for Main Services CI/CD to complete..."
          echo "This ensures DB sync runs after Docker builds are done"
          sleep 300  # 5ë¶„ ëŒ€ê¸° (Main Services CI/CD ì™„ë£Œ ëŒ€ê¸°)

      - name: ğŸ” Environment Info
        run: |
          echo "ğŸ” Workflow Info:"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Manual Environment: ${{ github.event.inputs.environment || 'N/A' }}"
      - name: ğŸš« Skip Auto-Commit Loops
        run: |
          # ìë™ ì»¤ë°‹ì—ì„œ ì˜¨ ê²½ìš° ìŠ¤í‚µ
          if [ "${{ github.event_name }}" = "push" ]; then
            COMMIT_MSG=$(git log -1 --pretty=%B)
            if echo "$COMMIT_MSG" | grep -qE "\[skip ci\]|\[ci skip\]|ğŸ¤– Auto-sync"; then
              echo "ğŸ¤– Auto-commit detected, skipping ORM generation"
              echo "SKIP_ORM=true" >> $GITHUB_ENV
            else
              echo "ğŸ‘¤ Manual commit detected, proceeding with ORM generation"
              echo "SKIP_ORM=false" >> $GITHUB_ENV
            fi
          else
            echo "ğŸ”§ Manual workflow dispatch, proceeding with ORM generation"
            echo "SKIP_ORM=false" >> $GITHUB_ENV
          fi

      - name: ğŸ›ï¸ Checkout Repository
        if: env.SKIP_ORM != 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        if: env.SKIP_ORM != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Global Dependencies
        if: env.SKIP_ORM != 'true'
        run: |
          npm install -g ts-node typescript

      - name: ğŸ”§ Setup Database Environment
        if: env.SKIP_ORM != 'true'
        run: |
          case "${{ github.ref_name }}" in
            "dev")
              # DEV í™˜ê²½ í•˜ë“œì½”ë”© (env/dev.env ì°¸ì¡°)
              echo "DB_HOST=localhost" >> $GITHUB_ENV
              echo "DB_PORT=3306" >> $GITHUB_ENV
              echo "DB_USERNAME=root" >> $GITHUB_ENV
              echo "DB_PASSWORD=" >> $GITHUB_ENV
              echo "DB_DATABASE=public" >> $GITHUB_ENV
              ;;
            "qa")
              echo "DB_HOST=${{ secrets.QA_DB_HOST }}" >> $GITHUB_ENV
              echo "DB_PORT=${{ secrets.QA_DB_PORT }}" >> $GITHUB_ENV
              echo "DB_USERNAME=${{ secrets.QA_DB_USER }}" >> $GITHUB_ENV
              echo "DB_PASSWORD=${{ secrets.QA_DB_PASSWORD }}" >> $GITHUB_ENV
              echo "DB_DATABASE=${{ secrets.QA_DB_NAME }}" >> $GITHUB_ENV
              ;;
            "production")
              echo "DB_HOST=${{ secrets.PROD_DB_HOST }}" >> $GITHUB_ENV
              echo "DB_PORT=${{ secrets.PROD_DB_PORT }}" >> $GITHUB_ENV
              echo "DB_USERNAME=${{ secrets.PROD_DB_USER }}" >> $GITHUB_ENV
              echo "DB_PASSWORD=${{ secrets.PROD_DB_PASSWORD }}" >> $GITHUB_ENV
              echo "DB_DATABASE=${{ secrets.PROD_DB_NAME }}" >> $GITHUB_ENV
              ;;
          esac

      - name: ğŸš€ Run Database Sync & Auto Commit
        if: env.SKIP_ORM != 'true'
        run: |
          # í™˜ê²½ ë§¤í•‘ (ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì…ë ¥ê°’ ìš°ì„ )
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV_NAME="${{ github.event.inputs.environment }}"
          else
            ENV_NAME="${{ github.ref_name }}"
            if [ "$ENV_NAME" = "production" ]; then
              ENV_NAME="prod"
            fi
          fi

          echo "ğŸš€ Running database sync for $ENV_NAME environment..."

          # ë³€ê²½ì‚¬í•­ ì¶”ì 
          git status --porcelain > /tmp/before.txt

          # DB ë™ê¸°í™” ì‹¤í–‰
          chmod +x scripts/run-enhanced-db-sync.sh
          ./scripts/run-enhanced-db-sync.sh "$ENV_NAME"

          # ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
          git status --porcelain > /tmp/after.txt

          if ! diff -q /tmp/before.txt /tmp/after.txt > /dev/null; then
            echo "ğŸ“ Changes detected, committing..."
            
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action Bot"
            
            git add -A
            git commit -m "ğŸ¤– Auto-sync database schema from $ENV_NAME environment [skip ci]"
            git push origin ${{ github.ref_name }}
            
            echo "âœ… Changes committed and pushed!"
          else
            echo "ğŸ“ No changes detected"
          fi

      - name: ğŸ“‹ ORM Generation Summary
        if: always()
        run: |
          if [ "${{ env.SKIP_ORM }}" = "true" ]; then
            echo "ğŸ¤– ORM Generation skipped - Auto-commit loop prevention"
            echo "This prevents infinite CI/CD loops from auto-generated commits"
          else
            echo "âœ… ORM Generation completed successfully"
            echo "Database schema has been synchronized"
          fi
