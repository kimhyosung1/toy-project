name: ğŸš€ Main Services CI/CD

on:
  push:
    branches: [dev, qa, production]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: toy-project-main-services

jobs:
  docker-build:
    name: ğŸ³ Docker Build & Push (Main Services)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    # strategy:
    #   matrix:
    #     service: [gateway, board]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ë³€ê²½ ê°ì§€ìš©)

      - name: ğŸ” Detect Changed Apps
        id: detect-apps
        run: |
          echo "ğŸ” ===== CI/CD Detection Started ====="
          echo "ğŸ“… Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Event: ${{ github.event_name }}"

          # ğŸš« ìë™ ì»¤ë°‹ ìŠ¤í‚µ ì²´í¬
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "ğŸ’¬ Last commit message: $COMMIT_MSG"

          if echo "$COMMIT_MSG" | grep -qE "\[skip ci\]|\[ci skip\]|ğŸ¤– Auto-sync"; then
            echo "ğŸ¤– Auto-commit detected - SKIPPING BUILD"
            echo "skip_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "ğŸ‘¤ Manual commit detected - PROCEEDING"

          # ğŸ” ë©”ì¸ ì„œë¹„ìŠ¤ ì•± ëª©ë¡ ìƒì„±
          # 1. ë³„ë„ CI/CD íŒŒì¼ ìŠ¤ìº”
          # .github/workflows/notification-ci-cd.yml  â†’ notification ì œì™¸
          # .github/workflows/scheduler-ci-cd.yml     â†’ scheduler ì œì™¸
          # .github/workflows/main-services-ci-cd.yml â†’ ì œì™¸ ëŒ€ìƒ ì•„ë‹˜

          # # 2. apps í´ë” ìŠ¤ìº” + ë™ì  ì œì™¸
          # apps/account/      âœ… í¬í•¨ (ë³„ë„ CI/CD ì—†ìŒ)
          # apps/board/        âœ… í¬í•¨ (ë³„ë„ CI/CD ì—†ìŒ)  
          # apps/file/         âœ… í¬í•¨ (ë³„ë„ CI/CD ì—†ìŒ)
          # apps/gateway/      âœ… í¬í•¨ (ë³„ë„ CI/CD ì—†ìŒ)
          # apps/notification/ âŒ ì œì™¸ (notification-ci-cd.yml ì¡´ì¬)
          # apps/scheduler/    âŒ ì œì™¸ (scheduler-ci-cd.yml ì¡´ì¬)
          echo ""
          echo "ğŸ” ===== Discovering Main Service Apps ====="
          MAIN_APPS=$(find apps -maxdepth 1 -type d -name "*" ! -name "apps" ! -name "notification" ! -name "scheduler" -exec basename {} \; | tr '\n' ',' | sed 's/,$//')
          echo "ğŸ“± Available main service apps: $MAIN_APPS"
          echo "âŒ Excluded apps: notification, scheduler (separate CI/CD)"

          # ğŸ“ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ (ì•ˆì „í•œ ë°©ì‹)
          echo ""
          echo "ğŸ“ ===== Analyzing Changed Files ====="
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
            echo "ğŸ“Š Comparison: HEAD~1 vs HEAD"
          else
            CHANGED_FILES=$(git ls-files)
            echo "ğŸ“Š First commit detected - analyzing all files"
          fi

          echo "ğŸ“„ Changed files count: $(echo "$CHANGED_FILES" | wc -l)"
          echo "ğŸ“„ Changed files:"
          echo "$CHANGED_FILES" | head -20
          if [ $(echo "$CHANGED_FILES" | wc -l) -gt 20 ]; then
            echo "... and $(($(echo "$CHANGED_FILES" | wc -l) - 20)) more files"
          fi

          # ğŸ¯ ë³€ê²½ëœ ì•± ê°ì§€
          echo ""
          echo "ğŸ¯ ===== App Change Detection ====="
          CHANGED_APPS=""

          # í•µì‹¬ íŒŒì¼ ë³€ê²½ ì‹œ ì „ì²´ ë¹Œë“œ (ìš°ì„  ì²´í¬)
          CORE_FILES=$(echo "$CHANGED_FILES" | grep -E "^(libs/|package\.json|pnpm-lock\.yaml|tsconfig|nest-cli\.json)" || true)
          if [ -n "$CORE_FILES" ]; then
            echo "ğŸ”„ Core files changed - FULL BUILD required:"
            echo "$CORE_FILES"
            CHANGED_APPS="$MAIN_APPS"
            echo "âœ… Building all apps: $CHANGED_APPS"
          else
            echo "ğŸ“± Checking individual app changes..."
            # ê°œë³„ ì•± ë³€ê²½ ì²´í¬
            for app in ${MAIN_APPS//,/ }; do
              APP_FILES=$(echo "$CHANGED_FILES" | grep "^apps/$app/" || true)
              if [ -n "$APP_FILES" ]; then
                CHANGED_APPS="${CHANGED_APPS:+$CHANGED_APPS,}$app"
                echo "âœ… App '$app' changed ($(echo "$APP_FILES" | wc -l) files)"
              else
                echo "âšª App '$app' unchanged"
              fi
            done
            
            # ë³€ê²½ëœ ì•±ì´ ì—†ìœ¼ë©´ ì „ì²´ ë¹Œë“œ (ì•ˆì „ì¥ì¹˜)
            if [ -z "$CHANGED_APPS" ]; then
              echo "âš ï¸  No specific apps detected - FALLBACK to full build"
              CHANGED_APPS="$MAIN_APPS"
            fi
          fi

          echo ""
          echo "ğŸ¯ ===== Final Decision ====="
          echo "ğŸš€ TARGET_APPS: $CHANGED_APPS"
          echo "ğŸ“Š Apps to build: $(echo "$CHANGED_APPS" | tr ',' '\n' | wc -l)"

          echo "target_apps=$CHANGED_APPS" >> $GITHUB_OUTPUT
          echo "skip_build=false" >> $GITHUB_OUTPUT
          echo "ğŸ” ===== Detection Completed ====="

      - name: ğŸ” Login to Container Registry
        if: steps.detect-apps.outputs.skip_build != 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Extract metadata
        if: steps.detect-apps.outputs.skip_build != 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=${{ github.ref_name }}-
            type=raw,value=latest,enable=${{ github.ref_name == 'production' }}

      - name: ğŸ—ï¸ Build and push Docker image
        if: steps.detect-apps.outputs.skip_build != 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NODE_ENV=${{ github.ref_name == 'production' && 'production' || github.ref_name }}
            TARGET_APPS=${{ steps.detect-apps.outputs.target_apps }}

      - name: ğŸ“‹ Build Summary
        if: always()
        run: |
          echo "ğŸ“‹ ===== CI/CD Build Summary ====="
          echo "ğŸ“… Completed: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"

          if [ "${{ steps.detect-apps.outputs.skip_build }}" = "true" ]; then
            echo "ğŸ¤– Result: BUILD SKIPPED"
            echo "ğŸ“ Reason: Auto-commit detected ([skip ci] tag)"
            echo "ğŸ’¡ This prevents infinite CI/CD loops from automated commits"
          else
            echo "âœ… Result: BUILD COMPLETED"
            echo "ğŸ¯ Built apps: ${{ steps.detect-apps.outputs.target_apps }}"
            echo "ğŸ“Š Total apps built: $(echo "${{ steps.detect-apps.outputs.target_apps }}" | tr ',' '\n' | wc -l)"
            echo "ğŸ³ Docker image: ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}"
            echo "ğŸ·ï¸  Image tags: ${{ steps.meta.outputs.tags }}"
          fi
          echo "ğŸ“‹ ===== Summary Complete ====="
